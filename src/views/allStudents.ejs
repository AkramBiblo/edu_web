<body
  id="allStudents"
  style="
    background: url(/img/allstudents.jpg) no-repeat center fixed;
    background-size: cover;
  "
> 
  <%- include("./partials/header.ejs") %>

  <div class="container p-3 text-center">
    <h1 class="welcomeMsg">All students</h1>
  </div>
  <div class="container p-3">
    <a class="btn btn-outline-info" href="/register/new">Add a new student</a>
    <a class="btn btn-outline-info admin-button" href="/admin">Admin Panel</a>
  </div>
  <div class="row">
    <div class="col-sm">
      
    </div>
    <div class="col">
      <div class="container p-3" style="max-width: 300px ;">
        <div class="input-group mb-3">
          <input type="text" class="form-control" id="search" placeholder="Search">
          <div class="input-group-append">
            <button class="btn btn-info" name="searchStudent">Search</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="container">
    <table class="table">
      <tbody>
        <tr id="tBody">
          
        </tr>
      </tbody>
    </table>
  </div>
  <div class="container p-3 f">
    <table class="table bg-dark text-light">
      <thead class="thead-light">
        <tr class="text-center">
          <th>Photo</th>
          <th>SID</th>
          <th>Name</th>
          <th>Section</th>
          <th>Class/Standard</th>
          <th>Father name</th>
          <th>Emergency Contact</th>
          <th>Presence</th>
          <th>Absence</th>
          <th>Edit</th>
          <th>Remove</th>
        </tr>
      </thead>
      <tbody>
       
        <% if (locals.message != null) { message.forEach(function(user) { %>
        <tr>
          <td>
            <img
              style="border-radius: 8px; max-height: 70px; max-width: 70px"
              src="/uploadedFiles/<%= user.file %>"
              alt="Avatar"
            />
          </td>
          <td>
            <%= user.sid %>
          </td>
          <td>
            <form action="/student_login" method="post">
              <input
                type="hidden"
                name="sid"
                value="<%= user.sid %>"
              />
              <input
                type="hidden"
                name="campus_key"
                value="<%= locals.campus_key %>"
              />
              <input type="hidden" name="password" value="<%= user.password %>" />
              <input
                class="btn btn-info"
                type="submit"
                name="submit"
                value="<%= user.nameEnglish %>"
              />
            </form>
          </td>
          <td><%= user.preferredSection %></td>
          <td><%= user.preferredClass %></td>
          <td><%= user.fNameEnglish %></td>
          <td><%= user.emergencyContact %></td>
          <td><%= user.presence %></td>
          <td><%= user.absence %></td>
          <td>
            <form action="/students/updateProfile" method="POST">
              <input type="hidden" name="sid" value="<%= user.sid %>">
              <button class="btn btn-outline-info" type="submit">Edit</button>
            </form>
          </td>
          <td>
            <input type="hidden" id="campus_key" value="<%= locals.campus_key %>">
            <button class="btn btn-outline-danger remove" name="remove" sid="<%= user.sid %>" sname="<%= user.nameEnglish %>" campus_key="<%= locals.campus_key %>">Remove</button>
          </td>
          <% if (user.shift == "") { %>
          <td>
            <div class="container-fluid d-flex">
              <form action="/register/changeshift" method="POST">
                <input type="hidden" name="sid" value="<%= user.sid %>">
                <input type="hidden" name="campus_key" value="<%= locals.campus_key %>">
                <select class="form-control" name="shift">
                  <option>Morning Shift</option>
                  <option>Afternoon Shift</option>
                </select>
                <button class="btn btn-outline-info" type="submit">Change</button>
              </form>
            </div>
          </td>
          <% } %>
        </tr>
        <% })} %>
      </tbody>
    </table>
  </div>
 
  <script>
    $('button').click((e) => {
        let name = e.target.getAttribute('name')
        if (name == 'searchStudent') {
            let searchIP = $('#search').val()
            let campus = getCookie('campus')

            $.ajax({
                url: `/students/search/${campus}/${searchIP}`,
                type: "GET",
                async: false,
                success: (data) => {
                    if (data.sid) {
                        let user = data

                        let Pclass = "";
                      switch (user.preferredClass) {
                        case "Class Six":
                          Pclass = "Class Six";
                          break;
                        case "Class 5":
                          Pclass = "Standard V";
                          break;
                        case "Class 4":
                          Pclass = "Standard IV";
                          break;
                        case "Class 3":
                          Pclass = "Standard III";
                          break;
                        case "Class 2":
                          Pclass = "Standard II";
                          break;
                        case "Class 1":
                          Pclass = "Standard I";
                          break;
                        case "Nursery":
                          Pclass = "Nursery";
                          break;
                        case "K.G":
                          Pclass = "K.G";
                          break;
                      }

                      $('#tBody').empty()
                        $('#tBody').append(`
                          <td>
                              <img
                                style="border-radius: 8px; max-height: 70px; max-width: 70px"
                                src="/uploadedFiles/${user.file}"
                                alt="Avatar"
                              />
                            </td>
                            <td>
                              ${user.sid}
                            </td>
                            <td>
                              <form action="/students/login" method="post">
                                <input
                                  type="hidden"
                                  name="name"
                                  value="${user.sid}"
                                />
                                <input
                                  type="hidden"
                                  name="password"
                                  value="${user.password}"
                                />
                                <input
                                  class="btn btn-info"
                                  type="submit"
                                  name="submit"
                                  value="${user.nameEnglish}"
                                />
                              </form>
                            </td>
                            <td>${user.preferredSection}</td>
                            <td>${Pclass}</td>
                            <td>${user.fNameEnglish}</td>
                            <td>${user.emergencyContact}</td>
                            <td>${user.presence}</td>
                            <td>${user.absence}</td>`)
                    } else {
                        $('#tBody').empty()
                      alert(data)                        
                    }
                }
            })
        } else if (name == 'remove') {
          let sid = e.target.getAttribute("sid")
          let name = e.target.getAttribute("sname")
          let c = e.target.getAttribute("campus")
          if (confirm(`Are you sure that you want to remove this student (Name: ${name} & SID: ${sid}) ?`)) {
            $.ajax({
              url: "/students/removeProfile",
              type: "post",
              data: { sid: sid, campus: c }
            })
            location.reload();
          }
        }
    })

    function getCookie(cname) {
      let name = cname + "=";
      let decodedCookie = decodeURIComponent(document.cookie);
      let ca = decodedCookie.split(';');
      for(let i = 0; i <ca.length; i++) {
        let c = ca[i];
        while (c.charAt(0) == ' ') {
          c = c.substring(1);
        }
        if (c.indexOf(name) == 0) {
          return c.substring(name.length, c.length);
        }
      }
      return "";
    }
</script>
</body>